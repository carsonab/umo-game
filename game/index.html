<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

    <script>
        var config = {
            width: 800,
            height: 600,
            type: Phaser.AUTO,
            parent: 'phaser-example',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var gameTime; // Current game time
        var distanceToMove; // Distance to move the bus along the path

        var graphics; // Graphics settings
        var curve; // The curve that the bus will follow
        var path;


        // Debugging/Dev Displays
        var mouseInfoText;
        var mouseDownDuration;


        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('bus', 'assets/bus.png');
        }

        function create() {
            this.input.mouse.disableContextMenu();

            // Debugging/Dev stuff
            mouseInfoText = this.add.text(10, 10, '', { fill: '#00ff00' });


            // Add curve to follow
            graphics = this.add.graphics();

            path = { t: 0, vec: new Phaser.Math.Vector2() };

            points = [];
            points.push(new Phaser.Math.Vector2(50, 400));
            points.push(new Phaser.Math.Vector2(200, 200));
            points.push(new Phaser.Math.Vector2(350, 300));
            points.push(new Phaser.Math.Vector2(500, 500));
            points.push(new Phaser.Math.Vector2(700, 400));

            curve = new Phaser.Curves.Spline(points);

            var bus = this.add.follower(curve, 50, 400, 'bus');
            bus.scaleX = 0.1;
            bus.scaleY = 0.1;

            // Do stuff when mouse button is released
            this.input.on('pointerup', function (pointer) {
                if (pointer.leftButtonReleased()) {
                    // Get time button was down (in ms)
                    mouseDownDuration = gameTime - pointer.downTime;

                    // Move the bus
                    // Move more the longer mouse is held down - 300 units of distance per second held
                    distanceToMove = mouseDownDuration / 1000 * 300;
                    // Normalize
                    normalizedDistToMove = distanceToMove / curve.getLength();

                    bus.startFollow({
                        targets: path,
                        from: 0,
                        to: normalizedDistToMove,
                        ease: 'Sine.easeInOut',
                        duration: 3000,
                        yoyo: false,
                        repeat: 0,
                        rotateToPath: true
                    });
                }
            });
        }

        function update(time, delta) {
            var pointer = this.input.activePointer;

            // Update the saved game time
            gameTime = time;

            // Clear graphics settings
            graphics.clear();

            // Draw the curve
            graphics.lineStyle(1, 0xffffff, 1);
            curve.draw(graphics, 64);


            // Update dev test stuff
            mouseInfoText.setText('Mouse held for: ' + mouseDownDuration);

        }

    </script>
</body>

</html>