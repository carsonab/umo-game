<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

    <script>
        var config = {
            width: 800,
            height: 600,
            type: Phaser.AUTO,
            parent: 'phaser-example',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var gameTime; // Current game time
        var totalDistancedMovedNormalized; // Total distance the bus has moved along the path (normalized 0 to 1)
        var lastBusPosition; // Current position of the bus

        var graphics; // Graphics settings
        var tweenFollower; // Progress of tween to move bus
        var path; // Path that the bus will follow (route)
        var stopDistancesNormalized = []; // Stops along the paths (normalized to path length)

        // Debugging/Dev Displays
        var mouseInfoText;
        var mouseDownDuration;

        var busImage; // The bus image
        var scene; // The game scene

        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('bus', 'assets/bus.png');
        }

        function create() {
            this.input.mouse.disableContextMenu();
            graphics = this.add.graphics();

            // Debugging/Dev stuff
            mouseInfoText = this.add.text(10, 10, '', { fill: '#00ff00' });

            // Init total distance moved
            totalDistancedMovedNormalized = 0;

            // Init bus
            busImage = this.add.image(50, 400, 'bus');
            busImage.scaleX = 0.10;
            busImage.scaleY = 0.10;
            lastBusPosition = new Phaser.Math.Vector2(100, 300);

            // Create path
            path = new Phaser.Curves.Path(50, 400);
            path.lineTo(50, 200);
            path.lineTo(200, 200);
            path.lineTo(200, 500);
            path.lineTo(700, 500);
            path.lineTo(700, 300);
            path.lineTo(300, 300);
            path.lineTo(300, 200);
            path.lineTo(500, 200);
            path.lineTo(500, 400);

            // Create stops
            stopDistancesNormalized.push(0.1);
            stopDistancesNormalized.push(0.3);
            stopDistancesNormalized.push(0.42);
            stopDistancesNormalized.push(0.6);
            stopDistancesNormalized.push(0.85);



            // Track progress of the bus along the path from the tween
            tweenFollower = { t: 0, vec: new Phaser.Math.Vector2() };

            // Save our scene for use later
            scene = this;

            // Do stuff when mouse button is released
            this.input.on('pointerup', function (pointer) {
                if (pointer.leftButtonReleased()) {
                    // Get time button was down (in ms)
                    mouseDownDuration = gameTime - pointer.downTime;

                    // Move the bus
                    // Move more the longer mouse is held down - 300 units of distance per second held
                    var distanceToMove = mouseDownDuration / 1000 * 300;
                    // Normalize
                    normalizedDistToMove = distanceToMove / path.getLength();

                    // Add to total moved
                    totalDistancedMovedNormalized += normalizedDistToMove;

                    // Move the bus
                    scene.tweens.add({
                        targets: tweenFollower,
                        t: totalDistancedMovedNormalized,
                        ease: 'Sine.easeInOut',
                        duration: 1200,
                        yoyo: false,
                        repeat: 0,
                        onUpdate: onBusMove
                    });
                }
            });
        }

        function update(time, delta) {

            // Update the saved game time
            gameTime = time;

            // Clear graphics settings
            graphics.clear();

            // Draw the path
            graphics.lineStyle(1, 0xffffff, 1);
            path.draw(graphics);

            // Draw the stops
            graphics.fillStyle(0x00ff00, 1);
            for (var curStop = 0; curStop < stopDistancesNormalized.length; curStop++) {
                var pointOnPath = new Phaser.Math.Vector2();
                path.getPoint(stopDistancesNormalized[curStop], pointOnPath);
                graphics.fillCircle(pointOnPath.x, pointOnPath.y, 10);
            }

            // Update dev test stuff
            var pointer = this.input.activePointer;
            mouseInfoText.setText([
                'x: ' + pointer.worldX,
                'y: ' + pointer.worldY,
                'isDown: ' + pointer.isDown,
                'Mouse held for: ' + mouseDownDuration,
                'DistanceMovedNorm: ' + totalDistancedMovedNormalized
            ]);

        }

        function onBusMove(tween, target, param) {
            // Update bus position
            path.getPoint(tweenFollower.t, tweenFollower.vec);
            busImage.setX(tweenFollower.vec.x);
            busImage.setY(tweenFollower.vec.y);

            // Update bus rotation
            var movedVector = new Phaser.Math.Vector2();
            movedVector.x = tweenFollower.vec.x - lastBusPosition.x;
            movedVector.y = tweenFollower.vec.y - lastBusPosition.y;
            busImage.setRotation(movedVector.angle());
            lastBusPosition.x = tweenFollower.vec.x;
            lastBusPosition.y = tweenFollower.vec.y;
        }

    </script>
</body>

</html>