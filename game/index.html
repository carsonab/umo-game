<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

    <script>
        var config = {
            width: 800,
            height: 600,
            type: Phaser.AUTO,
            parent: 'phaser-example',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var gameTime; // Current game time
        var distanceToMove; // Distance to move the bus along the path
        var totalDistancedMovedNormalized; // Total distance the bus has moved along the path (normalized 0 to 1)

        var graphics; // Graphics settings
        var curve; // The curve that the bus will follow
        var path; // Position to be on the path, normalized across the curve


        // Debugging/Dev Displays
        var mouseInfoText;
        var mouseDownDuration;

        var busImage;
        var scene;


        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('bus', 'assets/bus.png');
        }

        function create() {
            this.input.mouse.disableContextMenu();

            // Debugging/Dev stuff
            mouseInfoText = this.add.text(10, 10, '', { fill: '#00ff00' });

            // Init total distance moved
            totalDistancedMovedNormalized = 0;

            // Init bus
            busImage = this.add.image(100, 300, 'bus');
            busImage.scaleX = 0.10;
            busImage.scaleY = 0.10;

            // Add curve to follow
            graphics = this.add.graphics();

            path = { t: 0, vec: new Phaser.Math.Vector2() };

            points = [];
            points.push(new Phaser.Math.Vector2(50, 400));
            points.push(new Phaser.Math.Vector2(150, 200));
            points.push(new Phaser.Math.Vector2(200, 300));
            points.push(new Phaser.Math.Vector2(250, 500));
            points.push(new Phaser.Math.Vector2(300, 400));
            points.push(new Phaser.Math.Vector2(400, 400));
            points.push(new Phaser.Math.Vector2(500, 400));
            points.push(new Phaser.Math.Vector2(600, 400));
            points.push(new Phaser.Math.Vector2(700, 400));

            curve = new Phaser.Curves.Spline(points);

            scene = this;


            // Do stuff when mouse button is released
            this.input.on('pointerup', function (pointer) {
                if (pointer.leftButtonReleased()) {
                    // Get time button was down (in ms)
                    mouseDownDuration = gameTime - pointer.downTime;

                    // Move the bus
                    // Move more the longer mouse is held down - 300 units of distance per second held
                    distanceToMove = mouseDownDuration / 1000 * 300;
                    // Normalize
                    normalizedDistToMove = distanceToMove / curve.getLength();

                    // Add to total moved
                    totalDistancedMovedNormalized += normalizedDistToMove;

                    // Move the bus
                    scene.tweens.add({
                        targets: path,
                        t: totalDistancedMovedNormalized,
                        ease: 'Sine.easeInOut',
                        duration: 1200,
                        yoyo: false,
                        repeat: 0
                    });
                }
            });
        }

        function update(time, delta) {

            // Update the saved game time
            gameTime = time;

            // Clear graphics settings
            graphics.clear();

            // Draw the curve
            graphics.lineStyle(1, 0xffffff, 1);
            curve.draw(graphics, 64);

            // Draw the stops
            graphics.fillStyle(0x00ff00, 1);
            for (var i = 0; i < points.length; i++) {
                graphics.fillCircle(points[i].x, points[i].y, 10);
            }

            // Update bus position
            curve.getPointAt(path.t, path.vec);
            busImage.setX(path.vec.x);
            busImage.setY(path.vec.y);

            // Update bus rotation
            var tangentUnitVector = new Phaser.Math.Vector2();
            curve.getTangentAt(path.t, tangentUnitVector);
            busImage.setRotation(tangentUnitVector.angle());

            // Update dev test stuff
            var pointer = this.input.activePointer;
            mouseInfoText.setText([
                'x: ' + pointer.worldX,
                'y: ' + pointer.worldY,
                'isDown: ' + pointer.isDown,
                'Mouse held for: ' + mouseDownDuration,
                'DistanceMovedNorm' + totalDistancedMovedNormalized
            ]);

        }

    </script>
</body>

</html>