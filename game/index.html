<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

    <script>
        var config = {
            width: 800,
            height: 600,
            type: Phaser.AUTO,
            parent: 'phaser-example',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var gameTime; // Current game time
        var totalDistancedMovedNormalized; // Total distance the bus has moved along the path (normalized 0 to 1)
        var lastBusPosition; // Current position of the bus
        var lastBusPositionNorm; // Normalized last bus position along path
        var isBusStopped = true;
        var lastBusWasStopped = true;

        var graphics; // Graphics settings
        var tweenFollower; // Progress of tween to move bus
        var path; // Path that the bus will follow (route)

        // Stops
        var stopDistancesNormalized = []; // Stops along the paths (normalized to path length)
        var passengersAtStops = []; // Passengers at each stop
        var closestStop = -1;

        // Game state stuff
        var levelStatusText;
        var totalPassengersPickedUp = 0; // Total number of passengers picked up
        var movesRemaining = 10; // Total number of remaining moves before losing
        var numberOfPassengersToWin = 70; // Number of passengers that must be picked up to beat the level
        var isGameOver = false; // Have the game over conditions been met yet (either win or lose)

        // Debugging/Dev Displays
        var mouseInfoText;
        var mouseDownDuration;
        var isAtStop = false;

        var busImage; // The bus image
        var scene; // The game scene

        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('bus', 'assets/bus.png');

            var progressBar = this.add.graphics();
            var progressBox = this.add.graphics();
            progressBox.fillStyle(0x222222, 0.8);
            progressBox.fillRect(240, 270, 320, 50);

            var width = this.cameras.main.width;
            var height = this.cameras.main.height;
            var loadingText = this.make.text({
                x: width / 2,
                y: height / 2 - 50,
                text: 'Loading...',
                style: {
                    font: '20px monospace',
                    fill: '#ffffff'
                }
            });
            loadingText.setOrigin(0.5, 0.5);

            var percentText = this.make.text({
                x: width / 2,
                y: height / 2 - 5,
                text: '0%',
                style: {
                    font: '18px monospace',
                    fill: '#ffffff'
                }
            });
            percentText.setOrigin(0.5, 0.5);

            var assetText = this.make.text({
                x: width / 2,
                y: height / 2 + 50,
                text: '',
                style: {
                    font: '18px monospace',
                    fill: '#ffffff'
                }
            });

            assetText.setOrigin(0.5, 0.5);

            this.load.on('progress', function (value) {
                percentText.setText(parseInt(value * 100) + '%');
                progressBar.clear();
                progressBar.fillStyle(0xffffff, 1);
                progressBar.fillRect(250, 280, 300 * value, 30);
            });

            this.load.on('fileprogress', function (file) {
                assetText.setText('Loading Game: ' + file.key);
            });

            this.load.on('complete', function () {
                progressBar.destroy();
                progressBox.destroy();
                loadingText.destroy();
                percentText.destroy();
                assetText.destroy();
            });

            this.load.image('logo', 'assets/Cubic_CTS_UMO.png');
            for (var i = 0; i < 500; i++) {
                this.load.image('Awesome Gaming Experiences : ' + i, 'assets/Cubic_CTS_UMO.png');
            }
        }

        function create() {

            var logo = this.add.image(650, 150, 'logo');

            this.input.mouse.disableContextMenu();
            graphics = this.add.graphics();

            // Debugging/Dev stuff
            mouseInfoText = this.add.text(10, 10, '', { fill: '#00ff00' });

            // Game status text
            levelStatusText = this.add.text(400, 10, '', { fill: '#00ff00' });

            // Level complete text - win/lose
            levelCompleteText = this.add.text(300, 150, '', { fontSize: '35px', fill: '#00ff00' });

            // Init total distance moved
            totalDistancedMovedNormalized = 0;
            lastBusPositionNorm = 0;

            // Init bus
            busImage = this.add.image(50, 400, 'bus');
            busImage.scaleX = 0.10;
            busImage.scaleY = 0.10;
            lastBusPosition = new Phaser.Math.Vector2(100, 300);

            // Create path
            path = new Phaser.Curves.Path(50, 400);
            path.lineTo(50, 200);
            path.lineTo(200, 200);
            path.lineTo(200, 500);
            path.lineTo(700, 500);
            path.lineTo(700, 300);
            path.lineTo(300, 300);
            path.lineTo(300, 200);
            path.lineTo(500, 200);
            path.lineTo(500, 400);

            // Create stops
            stopDistancesNormalized.push(0.1);
            stopDistancesNormalized.push(0.3);
            stopDistancesNormalized.push(0.42);
            stopDistancesNormalized.push(0.6);
            stopDistancesNormalized.push(0.85);

            // Add passengers for stops
            // Random number at each stop
            // for (var curStop = 0; curStop < stopDistancesNormalized.length; curStop++) {
            //     var passengerText = this.add.text(10, 10, '', { fill: '#00ff00' });
            //     passengersAtStops.push({ numPassengers: getRandomInt(40), text: passengerText });
            // }
            // Manually set numbers
            passengersAtStops.push({ numPassengers: 10, text: this.add.text(10, 10, '', { fill: '#00ff00' }) });
            passengersAtStops.push({ numPassengers: 40, text: this.add.text(10, 10, '', { fill: '#00ff00' }) });
            passengersAtStops.push({ numPassengers: 15, text: this.add.text(10, 10, '', { fill: '#00ff00' }) });
            passengersAtStops.push({ numPassengers: 30, text: this.add.text(10, 10, '', { fill: '#00ff00' }) });
            passengersAtStops.push({ numPassengers: 20, text: this.add.text(10, 10, '', { fill: '#00ff00' }) });

            // Track progress of the bus along the path from the tween
            tweenFollower = { t: 0, vec: new Phaser.Math.Vector2() };

            // Save our scene for use later
            scene = this;

            // Do stuff when mouse button is released
            this.input.on('pointerup', function (pointer) {
                if (pointer.leftButtonReleased()) {
                    if (!isGameOver) {
                        // Get time button was down (in ms)
                        mouseDownDuration = gameTime - pointer.downTime;

                        // Move the bus
                        // Move more the longer mouse is held down - 300 units of distance per second held
                        var distanceToMove = mouseDownDuration / 1000 * 300;
                        // Normalize
                        normalizedDistToMove = distanceToMove / path.getLength();

                        // Add to total moved
                        totalDistancedMovedNormalized += normalizedDistToMove;

                        // Move the bus
                        var tween = scene.tweens.add({
                            targets: tweenFollower,
                            t: totalDistancedMovedNormalized,
                            ease: 'Sine.easeInOut',
                            duration: 1200,
                            yoyo: false,
                            repeat: 0,
                            onUpdate: onBusMove
                        });

                        // Decrease number of moves remaining
                        movesRemaining--;
                    }
                }
            });
        }

        function update(time, delta) {

            var pointer = this.input.activePointer;

            // Update the saved game time
            gameTime = time;

            // Clear graphics settings
            graphics.clear();

            // Draw the path
            graphics.lineStyle(1, 0xffffff, 1);
            path.draw(graphics);

            // Draw the stops and passengers
            graphics.fillStyle(0x00ff00, 1);
            for (var curStop = 0; curStop < stopDistancesNormalized.length; curStop++) {
                // Stops
                var pointOnPath = new Phaser.Math.Vector2();
                path.getPoint(stopDistancesNormalized[curStop], pointOnPath);
                graphics.fillCircle(pointOnPath.x, pointOnPath.y, 10);
                // Passengers
                passengersAtStops[curStop].text.setX(pointOnPath.x + 10); // Offset a little from the path
                passengersAtStops[curStop].text.setY(pointOnPath.y + 10); // Offset a little from the path
                passengersAtStops[curStop].text.setText(passengersAtStops[curStop].numPassengers);
            }

            // Check if bus is stopped
            if (lastBusPositionNorm == tweenFollower.t) {
                isBusStopped = true;
            } else {
                isBusStopped = false;
            }
            lastBusPositionNorm = tweenFollower.t;

            // Check if just stopped so that we can pick up passengers
            var closestDistNorm = 1.0;
            if (isBusStopped && !lastBusWasStopped) {
                // Find closest stop on route
                currentProgressNormalized = tweenFollower.t;
                for (var stop = 0; stop < stopDistancesNormalized.length; stop++) {
                    var distanceToStop = Math.abs(stopDistancesNormalized[stop] - currentProgressNormalized);
                    if (distanceToStop < closestDistNorm) {
                        closestDistNorm = distanceToStop;
                        closestStop = stop;
                    }
                }

                // Check if stop is close enough to pick up passengers
                var lengthToStop = closestDistNorm * path.getLength();
                if (lengthToStop < 30) {
                    isAtStop = true;
                    // Pick up the passengers
                    totalPassengersPickedUp += passengersAtStops[closestStop].numPassengers;
                    passengersAtStops[closestStop].numPassengers = 0;
                } else {
                    isAtStop = false;
                }

            }
            lastBusWasStopped = isBusStopped;

            // Check for win
            if (totalPassengersPickedUp >= numberOfPassengersToWin) {
                levelCompleteText.setText('You Win!');
                isGameOver = true;
            } else if (movesRemaining == 0 && totalPassengersPickedUp < numberOfPassengersToWin) {
                levelCompleteText.setText('You Lose!');
                isGameOver = true;
            }

            // Update level status info
            levelStatusText.setText([
                'totalPassengersPickedUp: ' + totalPassengersPickedUp,
                'movesRemaining: ' + movesRemaining,
                'totalPassengersNeededToWin: ' + numberOfPassengersToWin,
                'passengersRemaining: ' + (numberOfPassengersToWin - totalPassengersPickedUp)
            ]);

            // Update dev test stuff
            mouseInfoText.setText([
                'x: ' + pointer.worldX,
                'y: ' + pointer.worldY,
                'isDown: ' + pointer.isDown,
                'Mouse held for: ' + mouseDownDuration,
                'DistanceMovedNorm: ' + totalDistancedMovedNormalized,
                'isBusStopped: ' + isBusStopped,
                'closestStop: ' + closestStop,
                'isAtStop: ' + isAtStop
            ]);

        }

        function onBusMove(tween, target, param) {
            // Update bus position
            path.getPoint(tweenFollower.t, tweenFollower.vec);
            busImage.setX(tweenFollower.vec.x);
            busImage.setY(tweenFollower.vec.y);

            // Update bus rotation
            var movedVector = new Phaser.Math.Vector2();
            movedVector.x = tweenFollower.vec.x - lastBusPosition.x;
            movedVector.y = tweenFollower.vec.y - lastBusPosition.y;
            busImage.setRotation(movedVector.angle());
            lastBusPosition.x = tweenFollower.vec.x;
            lastBusPosition.y = tweenFollower.vec.y;
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

    </script>
</body>

</html>